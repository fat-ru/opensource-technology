
  * [概念](#概念)
    * [Make](#make)
    * [Makefile](#makefile)
  * [核心原理](#核心原理)
    * [依赖图](#依赖图)
    * [时间戳比较机制](#时间戳比较机制)
  * [基本语法](#基本语法)
    * [变量赋值](#变量赋值)
    * [内置变量](#内置变量)


## 概念

### Make  

Make是一个构建自动化工具。  
早期仅用于C/C++项目，现在广泛用于多语言项目和前后端混合项目。

### Makefile  

Makefile文件用于定义目标、依赖和规则，make解析Makefile文件，并fork shell程序执行命令。  

**目标**：需要生成的文件或抽象任务  

**依赖**：生成目标所依赖的文件  

**命令**：生成目标的命令序列  

**自动变量**：Make内置变量，例如$@（当前目标），$^（所有依赖）  

**伪目标**：不生成文件的目标  

## 核心原理  

Make基于依赖图和文件时间戳来决定是否需要构建/重新构建。  

> 目标: 依赖1 依赖2  
>   命令

### 依赖图

Make解析Makefile文件，将所有目标和依赖构建成一个有向无环图（DAG）  
图中的点即是目标、边即是依赖关系。

### 时间戳比较机制

Unix/Linux文件系统记录三个时间：  
mtime：文件内容最后修改时间  
ctime：文件元数据最后修改时间  
atime：文件最后访问时间  

Make比较目标和依赖的mtime，依赖更新则重建目标。

## 基本语法

### 变量赋值

- 简单赋值  

在使用变量时才解析表达式并赋值。  
```shell script
VAR = value
```

- 立即展开赋值  

直接解析表达式并赋值，变量后续不会因为表达式变化而变化。
```shell script
VAR := value
```

- 条件赋值  

如果未定义才赋值，即使变量为空，也不会再赋值。  
VAR ?= value  

- 追加赋值

在变量后面继续拼接值，以空格进行分隔。  
```shell script
VAR += value
```

### 内置变量  

- $@

当前规则的目标名称

- $<

第一个依赖文件

- $^

所有去重的依赖文件

- $?

所有比目标新的依赖文件

